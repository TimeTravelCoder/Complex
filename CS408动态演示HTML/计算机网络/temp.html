<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœ‚çªç§»åŠ¨é€šä¿¡ç½‘äº¤äº’å¼æŒ‡å— (ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f1f5f9; scroll-behavior: smooth; }
        .content-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px_12px -1px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .interactive-area {
            position: relative;
            width: 100%;
            height: 400px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .network-cloud {
            position: absolute;
            border: 2px dashed #94a3b8;
            background-color: #eef2ff;
            border-radius: 150px;
        }
        .network-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            color: #4338ca;
            background-color: rgba(255,255,255,0.7);
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.8rem;
        }
        .network-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.8s ease-in-out;
            z-index: 5;
        }
        .node-icon {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #94a3b8;
        }
        .node-icon.active { border-color: #3b82f6; transform: scale(1.1); }
        .node-label {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 4px;
            background: #ffffffaa;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .packet {
            position: absolute;
            width: 30px;
            height: 20px;
            background-color: #3b82f6;
            border: 2px solid #1e40af;
            border-radius: 4px;
            transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .packet.tunneled {
            background-color: #8b5cf6;
            border: 2px solid #5b21b6;
            transform: scale(1.2);
        }
        .packet.tunneled::after { content: ''; position: absolute; width: 80%; height: 80%; border: 2px dashed white; border-radius: 2px; }
        .path-line {
            position: absolute;
            height: 3px;
            background-color: #fbbf24; /* A bright color for the path */
            transform-origin: 0 50%;
            z-index: 4;
            transition: all 0.5s ease-in-out;
            border-radius: 2px;
            box-shadow: 0 0 8px #fbbf24;
        }
        .step-desc { min-height: 4rem; }
        .icon-router::before { content: 'â˜·'; font-size: 24px; color: #4f46e5; }
        .icon-server::before { content: 'ğŸ—„ï¸'; font-size: 24px; }
        .icon-phone::before { content: 'ğŸ“±'; font-size: 24px; }
        .icon-pstn::before { content: 'ğŸŒ'; font-size: 24px; }
        .icon-caller::before { content: 'â˜ï¸'; font-size: 24px; }
        .icon-computer::before { content: 'ğŸ’»'; font-size: 24px; }
        .icon-msc::before { content: 'ğŸ¢'; font-size: 24px; }
        .cell-tower { position: absolute; z-index: 1;}
        .cell-tower::before { content: 'ğŸ—¼'; font-size: 40px;}
        .cell-coverage { position: absolute; border-radius: 50%; border: 2px dashed; transition: all 0.5s; z-index: 0;}
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 tracking-tight">èœ‚çªç§»åŠ¨é€šä¿¡ç½‘ï¼šäº¤äº’å¼æ ¸å¿ƒæµç¨‹æŒ‡å—</h1>
            <p class="mt-4 text-lg text-slate-600 max-w-3xl mx-auto">é€šè¿‡å¯è§†åŒ–åŠ¨ç”»ï¼Œæ·±å…¥ç†è§£ç§»åŠ¨IPã€å‘¼å«è·¯ç”±ä¸ç½‘ç»œåˆ‡æ¢èƒŒåçš„å·¥ä½œåŸç†ã€‚</p>
        </header>
        
        <!-- Mobile IP Section -->
        <section id="mobile-ip" class="content-card mb-12 p-6 md:p-8">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4">ğŸ“ ç§»åŠ¨IP (Mobile IP) ä¸é—´æ¥è·¯ç”±</h2>
            <p class="text-slate-600 mb-6 leading-relaxed">
                ç§»åŠ¨IPæŠ€æœ¯å…è®¸è®¾å¤‡ï¼ˆç§»åŠ¨ç«™ï¼‰åœ¨ä¸åŒç½‘ç»œé—´æ¼«æ¸¸æ—¶ä¿æŒå…¶å›ºå®šçš„â€œæ°¸ä¹…åœ°å€â€ä¸å˜ï¼Œä»è€Œç»´æŒTCPç­‰ä¸Šå±‚è¿æ¥ä¸ä¸­æ–­ã€‚è¿™æ˜¯é€šè¿‡å½’å±ä»£ç†ã€å¤–åœ°ä»£ç†å’Œâ€œè½¬äº¤åœ°å€â€ååŒå·¥ä½œå®ç°çš„ã€‚ä¸‹é¢çš„åŠ¨ç”»å°†åˆ†æ­¥å±•ç¤ºä¸€ä¸ªæ•°æ®åŒ…å¦‚ä½•é€šè¿‡ **éš§é“æŠ€æœ¯** ä»é€šä¿¡è€…å‘é€åˆ°æ­£åœ¨æ¼«æ¸¸çš„ç§»åŠ¨ç«™ã€‚
            </p>

            <div class="interactive-area" id="mip-diagram">
                <!-- Network Clouds -->
                <div class="network-cloud" style="width: 300px; height: 300px; top: 50%; left: 25%; transform: translate(-50%, -50%);">
                    <span class="network-label">å½’å±ç½‘ç»œ</span>
                </div>
                <div class="network-cloud" style="width: 300px; height: 300px; top: 50%; left: 75%; transform: translate(-50%, -50%); background-color: #e0f2fe;">
                    <span class="network-label" style="color: #0369a1;">è¢«è®¿ç½‘ç»œ</span>
                </div>
                
                <!-- Nodes -->
                <div id="mip-node-b" class="network-node" style="top: 280px; left: 80px;"><span class="node-icon icon-computer"></span><span class="node-label">é€šä¿¡è€… B</span></div>
                <div id="mip-node-ha" class="network-node" style="top: 80px; left: 200px;"><span class="node-icon icon-router"></span><span class="node-label">å½’å±ä»£ç† (HA)</span></div>
                <div id="mip-node-fa" class="network-node" style="top: 100px; left: 550px;"><span class="node-icon icon-router"></span><span class="node-label">å¤–åœ°ä»£ç† (FA)</span></div>
                <div id="mip-node-a" class="network-node" style="top: 300px; left: 620px;"><span class="node-icon icon-phone"></span><span class="node-label">ç§»åŠ¨ç«™ A</span></div>
                
                <!-- Packet -->
                <div id="mip-packet" class="packet"></div>
            </div>

            <div class="mt-6 flex flex-col md:flex-row items-center justify-between bg-slate-50 p-4 rounded-lg">
                <p id="mip-desc" class="step-desc text-slate-700 font-medium text-center md:text-left mb-4 md:mb-0 flex-grow">ç‚¹å‡»â€œå¼€å§‹â€ä»¥å¯åŠ¨é—´æ¥è·¯ç”±è¿‡ç¨‹æ¼”ç¤ºã€‚</p>
                <div class="flex space-x-3">
                    <button id="mip-start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform hover:scale-105">å¼€å§‹ / é‡ç½®</button>
                    <button id="mip-next-btn" disabled class="bg-slate-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </section>

        <!-- Call Routing Section -->
        <section id="call-routing" class="content-card mb-12 p-6 md:p-8">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4">ğŸ“ å‘¼å«è·¯ç”±ä¸ç”¨æˆ·å®šä½</h2>
            <p class="text-slate-600 mb-6 leading-relaxed">
                å½“æ‚¨æ‹¨æ‰“ä¸€ä¸ªæ­£åœ¨æ¼«æ¸¸çš„æ‰‹æœºæ—¶ï¼Œç½‘ç»œå¦‚ä½•æ‰¾åˆ°å®ƒï¼Ÿè¿™ä¸ªè¿‡ç¨‹ä¾èµ–äºä¸¤ä¸ªå…³é”®æ•°æ®åº“ï¼š**å½’å±ä½ç½®å¯„å­˜å™¨ (HLR)** å’Œ **æ¥è®¿ç”¨æˆ·ä½ç½®å¯„å­˜å™¨ (VLR)**ã€‚HLRæ°¸ä¹…è®°å½•ç”¨æˆ·ä¿¡æ¯ï¼ŒVLRä¸´æ—¶è®°å½•æ¼«æ¸¸ç”¨æˆ·çš„ä½ç½®ã€‚ä¸‹é¢çš„åŠ¨ç”»å°†æ¨¡æ‹Ÿè¿™ä¸€æŸ¥è¯¢è¿‡ç¨‹ã€‚
            </p>

            <div class="interactive-area" id="call-diagram">
                <!-- Nodes -->
                <div id="call-node-caller" class="network-node" style="top: 180px; left: 50px;"><span class="node-icon icon-caller"></span><span class="node-label">å›ºå®šç”µè¯</span></div>
                <div id="call-node-pstn" class="network-node" style="top: 180px; left: 250px;"><span class="node-icon icon-pstn"></span><span class="node-label">å…¬ç”¨ç”µè¯ç½‘</span></div>
                <div id="call-node-hmsc" class="network-node" style="top: 80px; left: 550px;"><span class="node-icon icon-msc"></span><span class="node-label">å½’å± MSC</span></div>
                <div id="call-node-hlr" class="network-node" style="top: 160px; left: 550px;"><span class="node-icon icon-server"></span><span class="node-label">HLR</span></div>
                <div id="call-node-vmsc" class="network-node" style="top: 270px; left: 550px;"><span class="node-icon icon-msc"></span><span class="node-label">è¢«è®¿ MSC</span></div>
                <div id="call-node-vlr" class="network-node" style="top: 350px; left: 550px;"><span class="node-icon icon-server"></span><span class="node-label">VLR</span></div>
                <div id="call-node-mobile" class="network-node" style="top: 310px; left: 850px;"><span class="node-icon icon-phone"></span><span class="node-label">ç§»åŠ¨ç”¨æˆ·</span></div>

                 <!-- Call Path -->
                <div id="call-packet" class="packet" style="background-color: #10b981; border-color: #047857;"></div>
            </div>

            <div class="mt-6 flex flex-col md:flex-row items-center justify-between bg-slate-50 p-4 rounded-lg">
                <p id="call-desc" class="step-desc text-slate-700 font-medium text-center md:text-left mb-4 md:mb-0 flex-grow">ç‚¹å‡»â€œå¼€å§‹â€ä»¥æ¨¡æ‹Ÿå›ºå®šç”µè¯å‘¼å«æ¼«æ¸¸æ‰‹æœºçš„è¿‡ç¨‹ã€‚</p>
                <div class="flex space-x-3">
                    <button id="call-start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform hover:scale-105">å¼€å§‹ / é‡ç½®</button>
                    <button id="call-next-btn" disabled class="bg-slate-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </section>

        <!-- Handover Section -->
        <section id="handover" class="content-card p-6 md:p-8">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4">ğŸ”„ GSM ä¸­çš„åˆ‡æ¢ (Handover)</h2>
            <p class="text-slate-600 mb-6 leading-relaxed">
                å½“é€šè¯ä¸­çš„ç”¨æˆ·ä»ä¸€ä¸ªåŸºç«™è¦†ç›–åŒºç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ—¶ï¼Œç½‘ç»œå¿…é¡»æ— ç¼åœ°â€œåˆ‡æ¢â€æœåŠ¡åŸºç«™ä»¥ä¿æŒé€šè¯ä¸ä¸­æ–­ã€‚æ­¤è¿‡ç¨‹çš„å…³é”®æ˜¯**é”šMSC (Anchor MSC)**ï¼Œå®ƒæ˜¯åœ¨å‘¼å«å»ºç«‹æ—¶ç”¨æˆ·é¦–æ¬¡è®¿é—®çš„MSCã€‚åˆ‡æ¢æ—¶ï¼Œåªæœ‰ä»é”šMSCåˆ°æ–°åŸºç«™çš„è·¯å¾„ä¼šè¢«æ›´æ–°ã€‚
            </p>

            <div class="interactive-area" id="handover-diagram">
                <!-- Path container -->
                <div id="ho-path-container"></div>
                <!-- Nodes -->
                <div id="ho-node-hmsc" class="network-node" style="top: 50px; left: 150px;"><span class="node-icon icon-msc"></span><span class="node-label">å½’å± MSC</span></div>
                <div id="ho-node-amsc" class="network-node" style="top: 50px; left: 400px;"><span class="node-icon icon-msc" style="border-color: #f59e0b;"></span><span class="node-label">é”š MSC</span></div>
                <div id="ho-node-msc1" class="network-node" style="top: 200px; left: 250px;"><span class="node-icon icon-msc"></span><span class="node-label">åŸ MSC</span></div>
                <div id="ho-node-msc2" class="network-node" style="top: 200px; left: 550px;"><span class="node-icon icon-msc"></span><span class="node-label">æ–° MSC</span></div>
                <div id="ho-node-mobile" class="network-node" style="top: 320px; left: 250px;"><span class="node-icon icon-phone"></span><span class="node-label">ç§»åŠ¨ç”¨æˆ·</span></div>
                <!-- Cell Towers -->
                <div class="cell-tower" style="top: 280px; left: 230px;"></div>
                <div class="cell-tower" style="top: 280px; left: 530px;"></div>
                <div id="ho-cell1" class="cell-coverage" style="width: 250px; height: 250px; top: 200px; left: 130px; border-color: #22c55e;"></div>
                <div id="ho-cell2" class="cell-coverage" style="width: 250px; height: 250px; top: 200px; left: 430px; border-color: #94a3b8;"></div>
            </div>

            <div class="mt-6 flex flex-col md:flex-row items-center justify-between bg-slate-50 p-4 rounded-lg">
                <p id="ho-desc" class="step-desc text-slate-700 font-medium text-center md:text-left mb-4 md:mb-0 flex-grow">ç‚¹å‡»â€œå¼€å§‹åˆ‡æ¢â€è§‚å¯Ÿç”¨æˆ·ç§»åŠ¨å’Œå‘¼å«è·¯å¾„çš„æ”¹å˜ã€‚</p>
                <div class="flex space-x-3">
                    <button id="ho-start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform hover:scale-105">å¼€å§‹åˆ‡æ¢</button>
                    <button id="ho-reset-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform hover:scale-105">é‡ç½®</button>
                </div>
            </div>
        </section>

    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- General Helper Functions ---
    function getElementCenter(element, container) {
        const elRect = element.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const x = elRect.left + elRect.width / 2 - containerRect.left;
        const y = elRect.top + elRect.height / 2 - containerRect.top;
        return { x, y };
    }

    function highlightNode(node, duration = 2000) {
        if (node) {
            const icon = node.querySelector('.node-icon');
            icon.classList.add('active');
            setTimeout(() => icon.classList.remove('active'), duration);
        }
    }

    // --- Refactored Step-wise Animation Engine ---
    function setupStepwiseAnimation(config) {
        const diagram = document.getElementById(config.diagramId);
        const packet = document.getElementById(config.packetId);
        const btnStart = document.getElementById(config.startBtnId);
        const btnNext = document.getElementById(config.nextBtnId);
        const desc = document.getElementById(config.descId);
        const nodes = config.nodes;
        const steps = config.steps;
        let currentStep = 0;

        function movePacket(fromEl, toEl, duration = 1.5, onEnd = () => {}) {
            const startPos = getElementCenter(fromEl, diagram);
            const endPos = getElementCenter(toEl, diagram);
            
            packet.style.transition = 'none';
            packet.style.top = `${startPos.y - packet.offsetHeight / 2}px`;
            packet.style.left = `${startPos.x - packet.offsetWidth / 2}px`;
            packet.style.opacity = '1';
            
            setTimeout(() => {
                packet.style.transition = `all ${duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
                packet.style.top = `${endPos.y - packet.offsetHeight / 2}px`;
                packet.style.left = `${endPos.x - packet.offsetWidth / 2}px`;
            }, 50);

            setTimeout(onEnd, duration * 1000 + 100);
        }

        function reset() {
            currentStep = 0;
            desc.textContent = steps[0].desc;
            btnNext.disabled = true;
            btnNext.classList.add('bg-slate-400', 'cursor-not-allowed');
            btnNext.classList.remove('bg-sky-600', 'hover:bg-sky-700');
            packet.style.opacity = '0';
            if (packet.classList.contains('tunneled')) {
                packet.classList.remove('tunneled');
            }
        }

        btnStart.addEventListener('click', () => {
            reset();
            currentStep = 1;
            desc.textContent = steps[currentStep].desc;
            btnNext.disabled = false;
            btnNext.classList.remove('bg-slate-400', 'cursor-not-allowed');
            btnNext.classList.add('bg-sky-600', 'hover:bg-sky-700');
            const startNode = steps[1].from;
            const startPos = getElementCenter(nodes[startNode], diagram);
            packet.style.top = `${startPos.y - packet.offsetHeight / 2}px`;
            packet.style.left = `${startPos.x - packet.offsetWidth / 2}px`;
        });

        btnNext.addEventListener('click', () => {
            if (currentStep > 0 && currentStep < steps.length - 1) {
                const step = steps[currentStep];
                if (step.action) {
                    step.action(packet, nodes);
                }
                movePacket(nodes[step.from], nodes[step.to], step.duration || 1.5, () => {
                    if (step.onEnd) step.onEnd(packet, nodes);
                    highlightNode(nodes[step.to]);
                });
                
                currentStep++;
                desc.textContent = steps[currentStep].desc;

                if (currentStep === steps.length - 1) {
                    btnNext.disabled = true;
                    btnNext.classList.add('bg-slate-400', 'cursor-not-allowed');
                    btnNext.classList.remove('bg-sky-600', 'hover:bg-sky-700');
                }
            }
        });

        reset(); // Initial setup
    }

    // --- Mobile IP Animation Setup ---
    setupStepwiseAnimation({
        diagramId: 'mip-diagram',
        packetId: 'mip-packet',
        startBtnId: 'mip-start-btn',
        nextBtnId: 'mip-next-btn',
        descId: 'mip-desc',
        nodes: {
            b: document.getElementById('mip-node-b'),
            ha: document.getElementById('mip-node-ha'),
            fa: document.getElementById('mip-node-fa'),
            a: document.getElementById('mip-node-a'),
        },
        steps: [
            { desc: 'ç‚¹å‡»â€œå¼€å§‹â€ä»¥å¯åŠ¨é—´æ¥è·¯ç”±è¿‡ç¨‹æ¼”ç¤ºã€‚' },
            { desc: '1. é€šä¿¡è€… B å‘ç§»åŠ¨ç«™ A çš„æ°¸ä¹…åœ°å€å‘é€æ•°æ®åŒ…ã€‚æ•°æ®åŒ…é¦–å…ˆè¢«è·¯ç”±åˆ°Açš„å½’å±ç½‘ç»œã€‚', from: 'b', to: 'ha', onEnd: (pkt) => pkt.style.opacity = '0' },
            { desc: '2. å½’å±ä»£ç†(HA)æˆªè·æ•°æ®åŒ…ï¼Œå¹¶æŸ¥è¯¢åˆ° A çš„è½¬äº¤åœ°å€ã€‚HA å°†åŸå§‹æ•°æ®åŒ…å°è£…(IP-in-IPéš§é“)ï¼Œå‘å¾€è¯¥è½¬äº¤åœ°å€ã€‚', from: 'ha', to: 'fa', action: (pkt) => pkt.classList.add('tunneled') },
            { desc: '3. å¤–åœ°ä»£ç†(FA)æ”¶åˆ°å°è£…çš„æ•°æ®åŒ…ï¼Œå°†å…¶è§£å°ï¼Œæ¢å¤ä¸ºåŸå§‹æ•°æ®åŒ…ã€‚', from: 'fa', to: 'fa', duration: 0.1, action: (pkt) => { pkt.classList.remove('tunneled'); pkt.style.transform = 'scale(1.2)'; }, onEnd: (pkt) => pkt.style.transform = 'scale(1)' },
            { desc: '4. FA å°†åŸå§‹æ•°æ®åŒ…è½¬å‘ç»™å…¶æœåŠ¡èŒƒå›´å†…çš„ç§»åŠ¨ç«™ Aã€‚é€šä¿¡å®Œæˆã€‚', from: 'fa', to: 'a' },
            { desc: 'æ¼”ç¤ºç»“æŸã€‚ç‚¹å‡»â€œå¼€å§‹/é‡ç½®â€å¯å†æ¬¡è§‚çœ‹ã€‚' }
        ]
    });

    // --- Call Routing Animation Setup ---
    setupStepwiseAnimation({
        diagramId: 'call-diagram',
        packetId: 'call-packet',
        startBtnId: 'call-start-btn',
        nextBtnId: 'call-next-btn',
        descId: 'call-desc',
        nodes: {
            caller: document.getElementById('call-node-caller'),
            pstn: document.getElementById('call-node-pstn'),
            hmsc: document.getElementById('call-node-hmsc'),
            hlr: document.getElementById('call-node-hlr'),
            vmsc: document.getElementById('call-node-vmsc'),
            vlr: document.getElementById('call-node-vlr'),
            mobile: document.getElementById('call-node-mobile'),
        },
        steps: [
            { desc: 'ç‚¹å‡»â€œå¼€å§‹â€ä»¥æ¨¡æ‹Ÿå›ºå®šç”µè¯å‘¼å«æ¼«æ¸¸æ‰‹æœºçš„è¿‡ç¨‹ã€‚' },
            { desc: '1. å‘¼å«è¯·æ±‚ä»å›ºå®šç”µè¯å‘å‡ºï¼Œç»å…¬ç”¨ç”µè¯ç½‘(PSTN)æ ¹æ®æ‰‹æœºå·ç ï¼Œè·¯ç”±åˆ°ç”¨æˆ·çš„å½’å±ç§»åŠ¨äº¤æ¢ä¸­å¿ƒ(Home MSC)ã€‚', from: 'caller', to: 'hmsc', onEnd: (pkt) => pkt.style.opacity = '0' },
            { desc: '2. å½’å±MSCå‘å½’å±ä½ç½®å¯„å­˜å™¨(HLR)æŸ¥è¯¢ç”¨æˆ·å½“å‰ä½ç½®ã€‚', from: 'hmsc', to: 'hlr', duration: 0.8, onEnd: (pkt) => pkt.style.opacity = '0' },
            { desc: '3. HLRä¸­è®°å½•äº†ç”¨æˆ·çš„æ¼«æ¸¸å·(MSRN)ã€‚HLRå°†æ­¤æ¼«æ¸¸å·è¿”å›ç»™å½’å±MSCã€‚', from: 'hlr', to: 'hmsc', duration: 0.8, onEnd: (pkt) => pkt.style.opacity = '0' },
            { desc: '4. å½’å±MSCä½¿ç”¨æ¼«æ¸¸å·ï¼Œå°†å‘¼å«çš„ç¬¬äºŒæ®µè·¯ç”±åˆ°è¢«è®¿ç½‘ç»œçš„MSC (Visited MSC)ã€‚', from: 'hmsc', to: 'vmsc', onEnd: (pkt) => pkt.style.opacity = '0' },
            { desc: '5. è¢«è®¿MSCé€šè¿‡å…¶æ§åˆ¶çš„åŸºç«™ï¼Œæœ€ç»ˆå°†å‘¼å«é€è¾¾ç§»åŠ¨ç”¨æˆ·ã€‚å‘¼å«å»ºç«‹ã€‚', from: 'vmsc', to: 'mobile' },
            { desc: 'æ¼”ç¤ºç»“æŸã€‚ç‚¹å‡»â€œå¼€å§‹/é‡ç½®â€å¯å†æ¬¡è§‚çœ‹ã€‚' }
        ]
    });

    // --- Handover Animation ---
    const hoDiagram = document.getElementById('handover-diagram');
    const hoBtnStart = document.getElementById('ho-start-btn');
    const hoBtnReset = document.getElementById('ho-reset-btn');
    const hoDesc = document.getElementById('ho-desc');
    const hoMobile = document.getElementById('ho-node-mobile');
    const hoCell1 = document.getElementById('ho-cell1');
    const hoCell2 = document.getElementById('ho-cell2');
    const hoPathContainer = document.getElementById('ho-path-container');
    const hoNodes = {
        hmsc: document.getElementById('ho-node-hmsc'),
        amsc: document.getElementById('ho-node-amsc'),
        msc1: document.getElementById('ho-node-msc1'),
        msc2: document.getElementById('ho-node-msc2'),
        mobile: hoMobile
    };
    let hoState = 'initial';

    // Helper to draw a line between two nodes
    function drawLine(fromNode, toNode, container) {
        const from = getElementCenter(fromNode, container);
        const to = getElementCenter(toNode, container);
        const angle = Math.atan2(to.y - from.y, to.x - from.x) * 180 / Math.PI;
        const length = Math.sqrt(Math.pow(to.x - from.x, 2) + Math.pow(to.y - from.y, 2));

        const line = document.createElement('div');
        line.className = 'path-line';
        line.style.width = `${length}px`;
        line.style.left = `${from.x}px`;
        line.style.top = `${from.y}px`;
        line.style.transform = `rotate(${angle}deg)`;
        return line;
    }

    // Helper to draw the entire call path
    function drawCallPath(segments) {
        hoPathContainer.innerHTML = ''; // Clear old path
        segments.forEach(segment => {
            const line = drawLine(segment.from, segment.to, hoDiagram);
            hoPathContainer.appendChild(line);
        });
    }

    function hoReset() {
        hoMobile.style.left = '250px';
        hoCell1.style.borderColor = '#22c55e';
        hoCell2.style.borderColor = '#94a3b8';
        hoDesc.textContent = 'ç‚¹å‡»â€œå¼€å§‹åˆ‡æ¢â€è§‚å¯Ÿç”¨æˆ·ç§»åŠ¨å’Œå‘¼å«è·¯å¾„çš„æ”¹å˜ã€‚';
        
        // Draw initial path
        drawCallPath([
            { from: hoNodes.hmsc, to: hoNodes.amsc },
            { from: hoNodes.amsc, to: hoNodes.msc1 },
            { from: hoNodes.msc1, to: hoNodes.mobile }
        ]);

        hoState = 'initial';
        hoBtnStart.disabled = false;
        hoBtnStart.textContent = 'å¼€å§‹åˆ‡æ¢';
        hoBtnStart.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        hoBtnStart.classList.remove('bg-slate-400', 'cursor-not-allowed');
    }

    hoBtnStart.addEventListener('click', () => {
        if (hoState !== 'initial') return;
        hoState = 'moving';
        hoBtnStart.disabled = true;
        hoBtnStart.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        hoBtnStart.classList.add('bg-slate-400', 'cursor-not-allowed');

        hoDesc.textContent = 'ç”¨æˆ·æ­£åœ¨å‘å³ç§»åŠ¨ï¼Œå³å°†ç¦»å¼€åŸåŸºç«™è¦†ç›–åŒº...';
        hoMobile.style.left = '550px';

        // Redraw path to follow the mobile user
        drawCallPath([
            { from: hoNodes.hmsc, to: hoNodes.amsc },
            { from: hoNodes.amsc, to: hoNodes.msc1 },
            { from: hoNodes.msc1, to: hoNodes.mobile }
        ]);

        setTimeout(() => {
            hoDesc.textContent = 'ä¿¡å·å‡å¼±ï¼Œç½‘ç»œå†³å®šåˆ‡æ¢ï¼é”šMSCå°†å‘¼å«è·¯å¾„é‡å®šå‘åˆ°æ–°MSCã€‚';
            hoCell1.style.borderColor = '#94a3b8';
            hoCell2.style.borderColor = '#22c55e';
            
            // Draw the NEW path after handover
            drawCallPath([
                { from: hoNodes.hmsc, to: hoNodes.amsc },
                { from: hoNodes.amsc, to: hoNodes.msc2 },
                { from: hoNodes.msc2, to: hoNodes.mobile }
            ]);

            hoState = 'finished';
            hoBtnStart.textContent = 'åˆ‡æ¢å®Œæˆ';
        }, 2000); // Increased timeout to allow for path redrawing visibility
    });

    hoBtnReset.addEventListener('click', hoReset);

    // Initialize all animations
    hoReset();
});
</script>

</body>
</html>
